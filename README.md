# Go语言实现一个短链接服务器

## 主要模块
![架构图](http://o99lnabej.bkt.clouddn.com/%E7%9F%AD%E9%93%BE%E6%8E%A5.PNG)
### 1. web服务器
web服务器使用Go 官方库 net/http
### 2. 短链接生成/解码 模块
主要功能是1. 输入原网址，输出短链接；2.输入短链接，输出原网址。
> 每个原网址对应一个uint32类型的ID，把ID转换成64进制的6位字符串。所以理论上能生成的短链接上线大约是(2^32-1)。
>
> 考虑到大并发的情况下mysql写入会成为性能瓶颈，使用唯一ID生成器，将模块产生的数据(原链接/ID/短链接）放入消息队列，并直接向用户返回生成短链接。

### 3. 消息队列
使用通道来实现消息队列，用来存储【短链接生成模块】生成的数据

### 4. 数据存储模块

使用mysql分表存储存储 （原链接/ID/短链接）等数据

## 唯一ID生成器模块实现

```
// 唯一ID结构
type uuid struct {
	id uint32
}

type buffer struct {
	ch      chan *uuid   // 缓存通道 用来提高发号效率
	closed  uint32       // ID分发是否关闭 0. 未关闭 1. 已关闭
	closing sync.RWMutex // 用来防止 发号器关闭时产生的竞态条件
}
```
使用上面的结构，配合channel, 通过设置不同的起始数值和步长（如：起始 三个 0、1、2，则步长为 3）,达到快速发号。

### 本地测试测试数据
- 并发 100W 请求时 采用步长为
    - 采用步长为1  运行时长： 1.096564208s  1.141105927s  1.061966522s
    - 采用步长为10  运行时长： 456.754013ms  414.449289ms  447.156689ms
    - 采用步长为100   运行时长： 438.393466ms   399.649332ms   436.377879ms
    - 采用步长为1000  运行时长： 416.386446ms    428.015934ms   456.731165ms
- 并发 1000W 请求时
    - 采用步长为1   运行时长： 58.781200057s  1
    - 采用步长为10  运行时长： 3.978633857s   4.078337591s   4.570418771s  10
    - 采用步长为100 运行时长： 3.910908276s   4.020512699s   4.063973827s  100
    - 采用步长为1000 运行时长： 4.346152653s   3.893660565s  1000
- 并发 10000W 请求时
    - 采用步长为10  运行时长： 1m52.003938133s 10
    - 采用步长为100  运行时长： 2m26.98895532s 100
    - 采用步长为1000 运行时长： 2m30.990139906s 1000

#### 待完善部分

- 步长可配置
- 系统关闭时保存发号器数值 【完成】

